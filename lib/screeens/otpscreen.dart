import 'package:awesome_dialog/awesome_dialog.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:elbad/widgets/menupage.dart';
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:otp_text_field/otp_field.dart';
import 'package:otp_text_field/otp_field_style.dart';

class OtpScreen extends StatefulWidget {
  final String verificationId;
  final String dataTodelete;

  const OtpScreen(
      {super.key, required this.verificationId, required this.dataTodelete});

  @override
  _OtpScreenState createState() => _OtpScreenState();
}

class _OtpScreenState extends State<OtpScreen> {
  String otp = '';

  FirebaseAuth _auth = FirebaseAuth.instance;

  void verifyOTP() async {
    PhoneAuthCredential credential = PhoneAuthProvider.credential(
      verificationId: widget.verificationId,
      smsCode: otp,
    );

    print("Data Delected");
    _signInWithCredential(credential);
  }

  void _signInWithCredential(PhoneAuthCredential credential) async {
    try {
      final authResult = await _auth.signInWithCredential(credential);
      // User is signed in.
      final user = authResult.user;
      if (user != null) {
        AwesomeDialog(
          context: context,
          headerAnimationLoop: false,
          dialogType: DialogType.success,
          // title: 'No Header',
          desc:
              'Your Bike Has been Un-Parked Successfully from Second Row.against digital Token No : DI-0001. ',
          btnOkOnPress: () {
            Navigator.push(
              context,
              MaterialPageRoute(builder: (context) => menuPage()),
            );
          },
          btnOkIcon: Icons.check_circle,
        ).show();
        DocumentReference documentReference = FirebaseFirestore.instance
            .collection('uid')
            .doc('${widget.dataTodelete}');

        await documentReference.delete();
        print("pass");
        print("${widget.dataTodelete}");
        print('User signed in: ${user.uid}');
      } else {
        AwesomeDialog(
          context: context,
          headerAnimationLoop: false,
          dialogType: DialogType.error,
          // title: 'No Header',
          desc: 'Something Wrong',
          btnOkOnPress: () {
            debugPrint('Error');
          },
          btnOkIcon: Icons.check_circle,
        ).show();
        print("failllllllllllllllllllllll");
        print('User not signed in.');
      }
    } catch (e) {
      AwesomeDialog(
        context: context,
        headerAnimationLoop: false,
        dialogType: DialogType.error,
        // title: 'No Header',
        desc: 'Something Wrong',
        btnOkOnPress: () {
          debugPrint('Error');
        },
        btnOkIcon: Icons.check_circle,
      ).show();
      // Handle verification failure (e.g., invalid OTP).
      print('Error signing in: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Stack(children: [
      backgroudImage(),
      Scaffold(
        appBar: AppBar(
            backgroundColor: Colors.transparent,
            leading: IconButton(
              icon: Icon(Icons.arrow_back, color: Colors.white),
              onPressed: () => Navigator.of(context).pop(),
            )),
        backgroundColor: Colors.transparent,
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: <Widget>[
              Text(
                'Bike Park here',
                style: TextStyle(
                  fontSize: 21,
                  fontWeight: FontWeight.w700,
                  color: Color(0xff03DABB),
                ),
              ),
              SizedBox(height: 20),
              Center(
                child: OTPTextField(
                  keyboardType: TextInputType.number,

                  otpFieldStyle:
                      OtpFieldStyle(backgroundColor: Color(0xFF063A34)),
                  // controller: otpController,
                  length: 6,
                  width: MediaQuery.of(context).size.width,
                  textFieldAlignment: MainAxisAlignment.spaceAround,
                  fieldWidth: 45,
                  // fieldStyle: FieldStyle.box,
                  outlineBorderRadius: 15,
                  style: TextStyle(
                    fontSize: 17,
                    color: Colors.white,
                  ),
                  onChanged: (value) {
                    setState(() {
                      otp = value;
                    });
                    print("Changed: " + value);
                  },
                ),
              ),
              // TextFormField(
              //   keyboardType: TextInputType.number,
              //   onChanged: (value) {
              //     setState(() {
              //       otp = value;
              //     });
              //   },
              // ),
              SizedBox(height: 20),
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xff03DABB), // background
                ),
                onPressed: verifyOTP,
                child: Text('Verify OTP'),
              ),
            ],
          ),
        ),
      ),
    ]);
  }

  Widget backgroudImage() {
    return Container(
      decoration: BoxDecoration(
        image: DecorationImage(
          image: AssetImage('assets/BikeMap.jpg'),

          /// change this to your  image directory
          fit: BoxFit.cover,
          // colorFilter: ColorFilter.mode(Colors.black45, BlendMode.darken),
        ),
      ),
    );
  }
}



// import 'package:flutter/material.dart';
// import 'package:otp_text_field/otp_text_field.dart';
// import 'package:awesome_dialog/awesome_dialog.dart';

// import '../widgets/menupage.dart';

// class OtpScreen extends StatefulWidget {
//   const OtpScreen({super.key});

//   @override
//   State<OtpScreen> createState() => _OtpScreenState();
// }

// class _OtpScreenState extends State<OtpScreen> {
//   @override
//   Widget build(BuildContext context) {
//     return Stack(children: [
//       backgroudImage(),
//       Scaffold(
//         backgroundColor: Colors.transparent,
//         body: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             const Text(
//               'Bike Park here',
//               style: TextStyle(
//                 fontSize: 21,
//                 fontWeight: FontWeight.w700,
//                 color: Color(0xFF03DAA1),
//               ),
//             ),
//             SizedBox(
//               height: 25,
//             ),
//             Center(
//               child: OTPTextField(
//                   otpFieldStyle:
//                       OtpFieldStyle(backgroundColor: Color(0xFF063A34)),
//                   // controller: otpController,
//                   length: 4,
//                   width: MediaQuery.of(context).size.width,
//                   textFieldAlignment: MainAxisAlignment.spaceAround,
//                   fieldWidth: 45,
//                   // fieldStyle: FieldStyle.box,
//                   outlineBorderRadius: 15,
//                   style: TextStyle(
//                     fontSize: 17,
//                     color: Colors.white,
//                   ),
//                   onChanged: (pin) {
//                     print("Changed: " + pin);
//                   },
//                   onCompleted: (pin) {
//                     print("Completed: " + pin);
//                   }),
//             ),
//             SizedBox(
//               height: 20,
//             ),
//             AnimatedButton(
//               text: 'OTP Verify',
//               color: Colors.cyan,
//               pressEvent: () {
//                 AwesomeDialog(
//                   context: context,
//                   headerAnimationLoop: false,
//                   dialogType: DialogType.success,
//                   // title: 'No Header',
//                   desc:
//                       'Your Bike Has been Un-Parked Successfully from Second Row.against digital Token No : DI-0001. ',
//                   btnOkOnPress: () {
//                     Navigator.push(
//                       context,
//                       MaterialPageRoute(builder: (context) => menuPage()),
//                     );
//                   },
//                   btnOkIcon: Icons.check_circle,
//                 ).show();
//               },
//             )
//           ],
//         ),
//       ),
//     ]);
//   }

//  
// }
